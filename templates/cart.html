{% extends "base.html" %}

{% block content %}
<section class="container" style="padding-top: 50px; min-height: 60vh;">
    <h1 class="section-title" style="text-align: left;">Your Shopping Cart</h1>
    <div id="cart-content-view">
        <div id="cart-container">
            <!-- Cart items will be rendered by JS -->
            <p id="empty-cart-msg">Your cart is empty.</p>
        </div>

        <div id="cart-summary" style="display: none; margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1.5rem; font-weight: 700;">Total: ₹<span id="cart-total">0</span></span>
                <button class="btn btn-primary" id="checkout-btn">Checkout Now</button>
            </div>
        </div>
    </div>

    <!-- Checkout Features Section (Hidden by default) -->
    <div id="checkout-view" style="display: none; margin-top: 40px; border-top: 2px solid #eee; padding-top: 40px;">
        <button class="btn btn-outline" id="back-to-cart" style="margin-bottom: 20px;">&larr; Back to Cart</button>

        <div class="checkout-grid">
            <div class="checkout-form-container">
                <h2 style="margin-bottom: 20px;">Shipping Details</h2>
                <form id="details-form">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" placeholder="Enter your name" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" placeholder="Enter your phone" required>
                    </div>
                    <div class="form-group">
                        <label>Street Address</label>
                        <input type="text" placeholder="Enter street address" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" placeholder="City" required>
                        </div>
                        <div class="form-group">
                            <label>Pin Code</label>
                            <input type="text" placeholder="Pin Code" required>
                        </div>
                    </div>
                </form>
            </div>

            <div class="checkout-options">
                <div class="option-card">
                    <h3>Delivery Method</h3>
                    <div class="selection-group">
                        <label class="selection-item">
                            <input type="radio" name="delivery" value="0" checked>
                            <div class="item-text">
                                <span class="title">Standard Delivery</span>
                                <span class="desc">3-5 Business Days</span>
                            </div>
                            <span class="price">Free</span>
                        </label>
                        <label class="selection-item">
                            <input type="radio" name="delivery" value="150">
                            <div class="item-text">
                                <span class="title">Express Delivery</span>
                                <span class="desc">1-2 Business Days</span>
                            </div>
                            <span class="price">₹150</span>
                        </label>
                    </div>
                </div>

                <div class="option-card">
                    <h3>Payment Method</h3>
                    <div class="selection-group">
                        <label class="selection-item">
                            <input type="radio" name="payment" value="cod" checked>
                            <div class="item-text">
                                <span class="title">Cash on Delivery</span>
                                <span class="desc">Pay when you receive</span>
                            </div>
                        </label>
                        <label class="selection-item">
                            <input type="radio" name="payment" value="upi">
                            <div class="item-text">
                                <span class="title">UPI / QR Scan</span>
                                <span class="desc">Fast & Secure payment</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="final-summary">
                    <div class="summary-row">
                        <span>Items Total</span>
                        <span id="summary-items">₹0</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery Fee</span>
                        <span id="summary-delivery">₹0</span>
                    </div>
                    <div class="summary-row total">
                        <span>Grand Total</span>
                        <span id="summary-grand">₹0</span>
                    </div>
                    <button class="btn btn-primary" id="place-order-btn" style="width: 100%; margin-top: 20px;">Place
                        Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success View (Hidden by default) -->
    <div id="success-view" style="display: none; text-align: center; padding: 60px 20px;">
        <div class="success-icon" style="font-size: 80px; color: var(--accent); margin-bottom: 20px;">✓</div>
        <h2 style="font-size: 2.5rem; margin-bottom: 15px;">Order Placed Successfully!</h2>
        <p style="color: #666; font-size: 1.1rem; margin-bottom: 40px; max-width: 500px; margin-inline: auto;">
            Thank you for choosing Royal Weaves. Your order has been confirmed and we'll notify you as soon as it's
            shipped.
        </p>
        <div
            style="background: #f9f9f9; padding: 25px; border-radius: 12px; max-width: 400px; margin: 0 auto 40px; border: 1px dashed #ddd;">
            <p style="margin-bottom: 10px;">Order ID: <strong id="order-id">#RW-12345</strong></p>
            <p>Total Paid: <strong id="success-total">₹0</strong></p>
        </div>
        <a href="/" class="btn btn-primary">Continue Shopping</a>
    </div>
</section>

<style>
    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 40px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border 0.3s;
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--accent);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .option-card {
        background: #fdfdfd;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .option-card h3 {
        margin-bottom: 15px;
        font-size: 1.1rem;
    }

    .selection-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .selection-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .selection-item:hover {
        background: #fcfcfc;
    }

    .selection-item:has(input:checked) {
        border-color: var(--accent);
        background: #fff9e6;
    }

    .selection-item input {
        margin-right: 15px;
        width: 20px;
        height: 20px;
        accent-color: var(--accent);
    }

    .item-text {
        flex: 1;
    }

    .item-text .title {
        display: block;
        font-weight: 600;
    }

    .item-text .desc {
        font-size: 0.85rem;
        color: #888;
    }

    .final-summary {
        background: #1e1e1e;
        color: white;
        padding: 25px;
        border-radius: 12px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        opacity: 0.9;
    }

    .summary-row.total {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #444;
        font-size: 1.3rem;
        font-weight: 700;
        opacity: 1;
    }

    .cart-item {
        display: flex;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #eee;
    }

    .cart-item img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 20px;
    }

    .cart-item-info {
        flex: 1;
    }

    .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
    }

    .qty-btn {
        background: #f5f5f5;
        border: none;
        padding: 5px 12px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
    }

    .qty-btn:hover {
        background: #e0e0e0;
    }

    .qty-val {
        padding: 0 12px;
        font-weight: 600;
        min-width: 30px;
        text-align: center;
    }

    @media (max-width: 900px) {
        .checkout-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cartContainer = document.getElementById('cart-container');
        const emptyMsg = document.getElementById('empty-cart-msg');
        const summary = document.getElementById('cart-summary');
        const totalElement = document.getElementById('cart-total');

        // Views
        const cartView = document.getElementById('cart-content-view');
        const checkoutView = document.getElementById('checkout-view');
        const successView = document.getElementById('success-view');

        // Buttons
        const checkoutBtn = document.getElementById('checkout-btn');
        const backBtn = document.getElementById('back-to-cart');
        const placeOrderBtn = document.getElementById('place-order-btn');

        // Summary Elements
        const summaryItems = document.getElementById('summary-items');
        const summaryDelivery = document.getElementById('summary-delivery');
        const summaryGrand = document.getElementById('summary-grand');

        // Success Elements
        const orderIdEl = document.getElementById('order-id');
        const successTotalEl = document.getElementById('success-total');

        window.renderCart = function () {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];

            if (cart.length === 0 && successView.style.display !== 'block') {
                cartContainer.innerHTML = '<p id="empty-cart-msg">Your cart is empty.</p>';
                summary.style.display = 'none';
                cartView.style.display = 'block';
                checkoutView.style.display = 'none';
                return;
            }

            if (cart.length > 0) {
                emptyMsg.style.display = 'none';
                summary.style.display = 'block';
                cartContainer.innerHTML = '';

                let total = 0;

                cart.forEach(item => {
                    total += parseInt(item.price) * item.quantity;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <div style="display: flex; align-items: center;">
                            <img src="${item.image}" alt="${item.name}">
                            <div class="cart-item-info">
                                <h3>${item.name}</h3>
                                <p>₹${item.price}</p>
                            </div>
                        </div>
                        <div class="cart-item-controls">
                            <div class="quantity-controls">
                                <button class="qty-btn" onclick="decreaseQuantity('${item.id}')">−</button>
                                <span class="qty-val">${item.quantity}</span>
                                <button class="qty-btn" onclick="increaseQuantity('${item.id}')">+</button>
                            </div>
                            <button class="btn btn-outline" onclick="removeFromCart('${item.id}')" style="padding: 5px 15px; margin-left: 15px;">Remove</button>
                        </div>
                    </div>
                `;
                    cartContainer.appendChild(itemEl);
                });

                totalElement.innerText = total;
                updateCheckoutSummary();
            }
        };

        function updateCheckoutSummary() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) return;

            let itemsTotal = cart.reduce((sum, item) => sum + (parseInt(item.price) * item.quantity), 0);
            const deliveryFee = parseInt(document.querySelector('input[name="delivery"]:checked').value);

            summaryItems.innerText = '₹' + itemsTotal;
            summaryDelivery.innerText = deliveryFee === 0 ? 'Free' : '₹' + deliveryFee;
            summaryGrand.innerText = '₹' + (itemsTotal + deliveryFee);
        }

        // View Transitions
        if (checkoutBtn) {
            checkoutBtn.addEventListener('click', () => {
                cartView.style.display = 'none';
                checkoutView.style.display = 'block';
                successView.style.display = 'none';
                window.scrollTo(0, 0);
            });
        }

        if (backBtn) {
            backBtn.addEventListener('click', () => {
                cartView.style.display = 'block';
                checkoutView.style.display = 'none';
                successView.style.display = 'none';
                window.scrollTo(0, 0);
            });
        }

        // Delivery change event
        document.querySelectorAll('input[name="delivery"]').forEach(radio => {
            radio.addEventListener('change', updateCheckoutSummary);
        });

        // Place Order
        if (placeOrderBtn) {
            placeOrderBtn.addEventListener('click', () => {
                const fields = document.querySelectorAll('#details-form input');
                let valid = true;
                fields.forEach(f => { if (!f.value) valid = false; });

                if (!valid) {
                    alert('Please fill in all shipping details first!');
                    return;
                }

                const total = summaryGrand.innerText;

                // Set success view details
                if (orderIdEl) orderIdEl.innerText = '#RW-' + Math.floor(10000 + Math.random() * 90000);
                if (successTotalEl) successTotalEl.innerText = total;

                // Show success view
                cartView.style.display = 'none';
                checkoutView.style.display = 'none';
                successView.style.display = 'block';
                window.scrollTo(0, 0);

                localStorage.removeItem('cart');
                if (typeof updateCartCount === 'function') updateCartCount();
            });
        }

        window.removeFromCart = function (id) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart = cart.filter(item => item.id !== id);
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
            if (typeof updateCartCount === 'function') updateCartCount();
        };

        renderCart();
    });
</script>
{% endblock %}